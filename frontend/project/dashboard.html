<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Expense Planner â€” Dashboard</title>

<!-- Bootstrap & Icons -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet" />

<!-- Custom CSS -->
<link rel="stylesheet" href="css/style.css" />

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>

<!-- Background -->
<canvas id="galaxy-bg"></canvas>
<div id="light-icons-bg"></div>
<script src="js/background.js"></script>

<!-- NAVBAR -->

  <!-- NAVBAR (unchanged) -->
  <nav class="navbar navbar-expand-lg navbar-dark shadow-sm" id="navbar">
    <div class="container">
      <img src="logo2.png" alt="pocketheist" width="40" height="40" class="me-2">
      <a class="navbar-brand fw-bold" href="dashboard.html"><h1>PocketHeist</h1></a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navMenu">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navMenu">
        <ul class="navbar-nav ms-auto align-items-center">
          <li class="nav-item"><a class="nav-link active" href="dashboard.html">Dashboard</a></li>
          <li class="nav-item"><a class="nav-link" href="targets.html">Targets</a></li>
          <li class="nav-item"><a class="nav-link" href="split.html">SplitExpense</a></li>
          <li class="nav-item"><a class="nav-link " href="categories.html">Categories</a></li>
          <li class="nav-item"><a class="nav-link" href="reminders.html">Reminders</a></li>
          <li class="nav-item ms-3"><button id="themeToggle"></button></li>
          <!-- âœ… Logout button added -->
        <li class="nav-item ms-3">
          <button id="logoutBtn" class="btn btn-danger btn-sm px-3">
            <i class="bi bi-box-arrow-right me-1"></i> Logout
          </button>
        </li>

        </ul>
      </div>
    </div>
  </nav>
<!-- MAIN CONTENT -->
<div class="container my-4 page-anim">
  <h2 class="fw-semibold mb-3">Dashboard Overview</h2>
   <h3 id="welcomeUser" class="mb-4 text-primary"></h3>
  
  

  <!-- Expense Chart -->
  <div class="card p-4 mb-4 shadow card-hover fade-in">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <div class="d-flex align-items-center gap-2">
        <h5 class="mb-0">Expense Chart</h5>
        <select id="rangeSelect" class="form-select form-select-sm w-auto">
          <option value="monthly" selected>Monthly</option>
          <option value="weekly">Weekly</option>
          <option value="daily">Daily</option>
        </select>
        <!-- category filter inserted here by script -->
      </div>
      <div class="text-end small text-muted">
        <div id="trendText"></div>
      </div>
    </div>
    <canvas id="expenseChart" height="150"></canvas>
  </div>

  <!-- Add Expense Form -->
  <div class="card p-4 mb-4 shadow card-hover fade-in">
    <h6>Add New Expense</h6>
    <form id="addExpenseForm" class="row g-2 mt-2">
      <div class="col-md-3"><input id="amount" required class="form-control" type="number" placeholder="Amount" /></div>
      <div class="col-md-3"><input id="category" required class="form-control" placeholder="Category" /></div>
      <div class="col-md-3"><input id="description" class="form-control" placeholder="Description" /></div>
      <div class="col-md-2"><input id="date" class="form-control" type="date" /></div>
      <div class="col-md-1 d-flex align-items-end">
        <button type="submit" class="btn btn-primary w-100 fw-semibold">ðŸ’¾ Add</button>
      </div>
    </form>
  </div>

  <!-- Summary Cards -->
  <div class="row g-3">
    <div class="col-md-4">
      <div class="card p-3 shadow card-hover fade-in">
        <h6>Total Spent</h6>
        <p id="totalSpent" class="fs-4 fw-semibold">â‚¹0</p>
        <div class="small text-muted">Recent</div>
        <ul id="recentList" class="mb-0 small" style="list-style:none;padding-left:0;"></ul>
      </div>
    </div>
    <div class="col-md-4">
      <div id="targetCard" class="card p-3 shadow card-hover fade-in">
        <h6>Target</h6>
        <p id="targetAmount" class="fs-4 fw-semibold">â‚¹1000</p>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card p-3 shadow card-hover fade-in">
        <h6>Progress</h6>
        <div class="progress mt-2" style="height:12px;">
          <div id="progressBar" class="progress-bar bg-primary" role="progressbar" style="width:0%">0%</div>
        </div>
        <div id="budgetWarning" class="small text-danger mt-2 d-none"></div>
      </div>
    </div>
  </div>
</div>

<!-- BOTTOM NAV -->
<div class="bottom-nav shadow-lg">
  <a data-page="dashboard" href="dashboard.html" class="active"><i class="bi bi-house"></i><span>Home</span></a>
  <a data-page="targets" href="targets.html"><i class="bi bi-bullseye"></i><span>Targets</span></a>
  <a data-page="splitwise" href="split.html"><i class="bi bi-people"></i><span>SplitExpense</span></a>
  <a data-page="categories" href="categories.html"><i class="bi bi-list"></i><span>Categories</span></a>
  <a data-page="reminders" href="reminders.html"><i class="bi bi-bell"></i><span>Reminders</span></a>
</div>

<!-- Scripts -->
<script src="https://cdn.botpress.cloud/webchat/v3.3/inject.js"></script>
<script src="https://files.bpcontent.cloud/2025/10/07/11/20251007115828-7Y93C0YO.js" defer></script>
<script src="js/app.js"></script>
<script>
/* ------------------- Dashboard Enhanced Script -------------------
   - Category-wise line chart (Chart.js)
   - Range filtering (daily/weekly/monthly)
   - Category selection dropdown
   - Recent list + totals + progress + trend + budget warning
   - Data via API with localStorage cache fallback
   - Target persisted in localStorage
------------------------------------------------------------------*/
document.addEventListener('DOMContentLoaded', () => {
  // Config
  const API_URL = "http://localhost:5000/api/transactions"; // keep as is or change if needed
  const USER_ID = "652c4f9a3f2e8c2a7f1e9b30"; // replace with dynamic userId if available
  const CACHE_KEY = "tx_cache_v1";
  const TARGET_KEY = "userTarget_v1";

  // DOM
  const rangeSelect = document.getElementById('rangeSelect');
  const chartCanvas = document.getElementById('expenseChart');
  const recentList = document.getElementById('recentList');
  const totalSpentEl = document.getElementById('totalSpent');
  const progressBar = document.getElementById('progressBar');
  const targetAmountEl = document.getElementById('targetAmount');
  const budgetWarning = document.getElementById('budgetWarning');
  const trendText = document.getElementById('trendText');

  // Category select inserted next to range
  const categorySelect = document.createElement('select');
  categorySelect.className = "form-select form-select-sm w-auto ms-2";
  categorySelect.id = "categorySelect";
  categorySelect.innerHTML = `<option value="all">All Categories</option>`;
  rangeSelect.insertAdjacentElement('afterend', categorySelect);

  // Target UI (input + save)
  const targetDisplay = document.getElementById('targetAmount');
  const targetContainer = document.createElement('div');
  targetContainer.className = 'd-flex align-items-center gap-2 mt-2';
  const targetInput = document.createElement('input');
  targetInput.type = 'number';
  targetInput.className = 'form-control form-control-sm';
  targetInput.style.width = '120px';
  const saveBtn = document.createElement('button');
  saveBtn.className = 'btn btn-sm btn-outline-primary';
  saveBtn.textContent = 'Save';
  targetContainer.appendChild(targetInput);
  targetContainer.appendChild(saveBtn);
  targetDisplay.after(targetContainer);

  // Chart
  const ctx = chartCanvas.getContext('2d');
  let chart = null;

  // helpers
  const formatCurrency = v => 'â‚¹' + Number(v || 0).toLocaleString();
  const formatDDMMYYYY = d => {
    if (!d) return '';
    const dt = new Date(d);
    if (isNaN(dt)) return '';
    return dt.toLocaleDateString('en-GB');
  };
  const isoDate = d => {
    const dt = new Date(d);
    return dt.toISOString();
  };

  // load / save cache
  function loadCache(){
    try { return JSON.parse(localStorage.getItem(CACHE_KEY) || '[]'); }
    catch(e){ console.warn('cache parse fail', e); return []; }
  }
  function saveCache(arr){
    localStorage.setItem(CACHE_KEY, JSON.stringify(arr));
  }

  // target persistence
  let target = Number(localStorage.getItem(TARGET_KEY) || 1000);
  targetInput.value = target;
  targetAmountEl.textContent = formatCurrency(target);

  saveBtn.addEventListener('click', ()=>{
    const v = Number(targetInput.value);
    if (!v || v <= 0) { alert('Enter valid target'); return; }
    target = v;
    localStorage.setItem(TARGET_KEY, String(target));
    targetAmountEl.textContent = formatCurrency(target);
    renderChart(); // update progress
  });

  // fetch from API, fallback to cache
  async function fetchExpensesFromApi(){
    try {
      const res = await fetch(`${API_URL}?userId=${USER_ID}`);
      if (!res.ok) throw new Error('API not OK');
      const data = await res.json();
      const list = Array.isArray(data) ? data : (data.transactions || []);
      // normalize: ensure numeric amount and date
      const normalized = list.map(t => ({
        id: t._id || t.id || (Math.random().toString(36).slice(2,9)),
        userId: t.userId || t.user || USER_ID,
        amount: Number(t.amount || 0),
        category: t.category || 'Uncategorized',
        description: t.description || '',
        date: t.date ? new Date(t.date).toISOString() : new Date().toISOString()
      }));
      // update cache
      saveCache(normalized);
      return normalized;
    } catch (err) {
      console.warn('API fetch failed, using cache', err);
      return loadCache();
    }
  }

  // add expense to API and update cache
  async function addExpense(tx){
    // tx: { amount, category, description, date }
    try {
      const body = { ...tx, userId: USER_ID, type: 'expense' };
      const res = await fetch(API_URL, {
        method: 'POST',
        headers: { 'Content-Type':'application/json' },
        body: JSON.stringify(body)
      });
      if (res.ok) {
        const response = await res.json();
        // backend returns saved transaction; normalize id & date
        const saved = response.transaction || response || {};
        const item = {
          id: saved._id || saved.id || (Math.random().toString(36).slice(2,9)),
          userId: saved.userId || USER_ID,
          amount: Number(saved.amount || tx.amount),
          category: saved.category || tx.category,
          description: saved.description || tx.description || '',
          date: saved.date ? new Date(saved.date).toISOString() : (new Date(tx.date).toISOString())
        };
        // push into cache
        const c = loadCache();
        c.push(item);
        saveCache(c);
        return item;
      } else {
        // still push to cache as offline entry
        throw new Error('server error');
      }
    } catch (err) {
      // API failed â€” store offline in cache so user data not lost
      const offline = {
        id: 'local_' + Date.now().toString(36),
        userId: USER_ID,
        amount: Number(tx.amount),
        category: tx.category,
        description: tx.description || '',
        date: new Date(tx.date).toISOString()
      };
      const c = loadCache();
      c.push(offline);
      saveCache(c);
      console.warn('Added to local cache because API failure', err);
      return offline;
    }
  }

  // period helpers
  function startOfToday(){ const d=new Date(); d.setHours(0,0,0,0); return d; }
  function startOfWeek(){ const d = startOfToday(); const day = d.getDay(); d.setDate(d.getDate() - (day === 0 ? 6 : day - 1)); return d; } // Mon-start
  function startOfMonth(){ const d = startOfToday(); d.setDate(1); return d; }
  function startOfPrevRange(range){
    const now = new Date();
    if (range === 'daily'){
      const prev = new Date(now); prev.setDate(now.getDate() - 1); prev.setHours(0,0,0,0); return prev;
    }
    if (range === 'weekly'){
      const prev = new Date(now); prev.setDate(now.getDate() - 7); return prev;
    }
    // monthly
    const prev = new Date(now); prev.setMonth(now.getMonth() - 1); return prev;
  }

  function inRange(dateStr, range){
    const d = new Date(dateStr);
    const now = new Date();
    if (range === 'daily') {
      return d.toDateString() === now.toDateString();
    } else if (range === 'weekly') {
      const start = startOfWeek();
      return d >= start && d <= now;
    } else { // monthly
      return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear();
    }
  }

  // group by category & date label
  function groupByCategoryAndDate(items){
    // returns { categoryName: { 'dd/mm/yyyy': total, ... }, ... }
    const g = {};
    items.forEach(it => {
      const cat = it.category || 'Uncategorized';
      const label = formatDDMMYYYY(it.date);
      if (!g[cat]) g[cat] = {};
      g[cat][label] = (g[cat][label] || 0) + Number(it.amount || 0);
    });
    return g;
  }

  // build full sorted date list (ensuring today's on right)
  function buildSortedLabels(items){
    const s = new Set();
    items.forEach(it => s.add(formatDDMMYYYY(it.date)));
    // convert & sort by ISO date
    const arr = Array.from(s);
    arr.sort((a,b) => {
      const da = a.split('/').reverse().join('-'); // yyyy-mm-dd
      const db = b.split('/').reverse().join('-');
      return new Date(da) - new Date(db);
    });
    return arr;
  }

  // palette
  const palette = ['#007bff','#28a745','#ffc107','#dc3545','#17a2b8','#6610f2','#6f42c1','#fd7e14','#20c997','#e83e8c'];

  // render Chart
  function renderChartWithData(items){
    // items already filtered by range and category selection
    const grouped = groupByCategoryAndDate(items);
    const labels = buildSortedLabels(items);
    // datasets per category
    const datasets = Object.keys(grouped).map((cat,i) => ({
      label: cat,
      data: labels.map(lbl => grouped[cat][lbl] || 0),
      borderColor: palette[i % palette.length],
      backgroundColor: palette[i % palette.length] + '33',
      tension: 0.3,
      fill: false,
      borderWidth: 2,
      pointRadius: 3,
      pointHoverRadius: 6
    }));

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
      type: 'line',
      data: { labels, datasets },
      options: {
        responsive: true,
        interaction: { mode: 'index', intersect: false },
        plugins: {
          legend: { position: 'bottom', labels: { usePointStyle: true } },
          tooltip: {
            callbacks: {
              label: ctx => `${ctx.dataset.label}: â‚¹${ctx.formattedValue}`
            }
          }
        },
        scales: {
          y: { beginAtZero: true, title: { display:true, text:'Amount (â‚¹)' } },
          x: { title: { display:true, text:'Date (DD/MM/YYYY)' } }
        }
      }
    });
  }

  // update summary + recent + progress + trend
  function updateSummaryAndRecent(allFiltered){
    const total = allFiltered.reduce((s,i)=> s + Number(i.amount || 0), 0);
    totalSpentEl.textContent = formatCurrency(total);

    // recent (latest 5)
    const sorted = [...allFiltered].sort((a,b)=> new Date(b.date) - new Date(a.date));
    recentList.innerHTML = sorted.slice(0,5).map(r => `<li style="padding:4px 0;">${formatDDMMYYYY(r.date)} â€¢ <strong>${formatCurrency(r.amount)}</strong> <span class="text-muted">(${r.category})</span> â€” ${escapeHtml(r.description || '')}</li>`).join('');

    // progress vs target
    const progress = Math.min((total / target) * 100, 100);
    progressBar.style.width = `${progress}%`;
    progressBar.textContent = `${Math.round(progress)}%`;
    if (progress >= 90) {
      budgetWarning.classList.remove('d-none');
      budgetWarning.textContent = `âš ï¸ You're at ${Math.round(progress)}% of your target`;
    } else {
      budgetWarning.classList.add('d-none');
      budgetWarning.textContent = '';
    }

    // trend vs previous period
    const range = rangeSelect.value;
    const prevStart = startOfPrevRange(range);
    const now = new Date();
    let prevTotal = 0;
    // compute previous window totals
    if (range === 'daily') {
      const prevDay = new Date(); prevDay.setDate(now.getDate() - 1);
      prevTotal = loadCache().filter(it => (new Date(it.date)).toDateString() === prevDay.toDateString()).reduce((s,i)=> s + Number(i.amount||0), 0);
    } else if (range === 'weekly') {
      const startThis = startOfWeek();
      const startPrev = new Date(startThis); startPrev.setDate(startThis.getDate() - 7);
      prevTotal = loadCache().filter(it => {
        const d = new Date(it.date);
        return d >= startPrev && d < startThis;
      }).reduce((s,i)=> s + Number(i.amount||0), 0);
    } else {
      // monthly
      const nowMonth = now.getMonth(), nowYear = now.getFullYear();
      const prevMonth = new Date(now); prevMonth.setMonth(nowMonth - 1);
      const prevMonthNum = prevMonth.getMonth(), prevYear = prevMonth.getFullYear();
      prevTotal = loadCache().filter(it => {
        const d = new Date(it.date);
        return d.getMonth() === prevMonthNum && d.getFullYear() === prevYear;
      }).reduce((s,i)=> s + Number(i.amount||0), 0);
    }

    let trendHtml = '';
    if (prevTotal === 0 && total === 0) trendHtml = `<span class="text-muted">No change</span>`;
    else if (prevTotal === 0) trendHtml = `<span class="text-success">+100% (new)</span>`;
    else {
      const pct = ((total - prevTotal)/prevTotal) * 100;
      const sign = pct >= 0 ? '+' : '';
      const cls = pct >= 0 ? 'text-danger' : 'text-success'; // increase is bad -> red
      trendHtml = `<span class="${cls}">${sign}${pct.toFixed(1)}%</span> vs previous`;
    }
    trendText.innerHTML = trendHtml;
  }

  // update category dropdown from items
  function populateCategorySelect(items){
    const cats = Array.from(new Set(items.map(i => i.category || 'Uncategorized'))).sort();
    categorySelect.innerHTML = `<option value="all">All Categories</option>` + cats.map(c => `<option value="${escapeHtmlAttr(c)}">${escapeHtml(c)}</option>`).join('');
  }

  // main render pipeline: fetch -> filter -> render
  async function renderChart(){
    const all = await fetchExpensesFromApi();
    // apply range filter
    const range = rangeSelect.value;
    const category = categorySelect.value || 'all';

    const filtered = all.filter(it => inRange(it.date, range));
    const finalFiltered = category === 'all' ? filtered : filtered.filter(it => it.category === category);

    // If user selected a single category we still want dataset only for that category,
    // otherwise include all categories (Chart will list them).
    renderChartWithData(finalFiltered);

    updateSummaryAndRecent(finalFiltered);

    populateCategorySelect(all); // show all categories seen across API/cache for selection
  }

  // Escape helpers
  function escapeHtml(s=''){ return String(s).replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function escapeHtmlAttr(s=''){ return String(s).replace(/"/g, '&quot;'); }

  // form submit
  document.getElementById('addExpenseForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    const amount = Number(document.getElementById('amount').value || 0);
    const category = document.getElementById('category').value.trim() || 'Uncategorized';
    const description = document.getElementById('description').value.trim();
    const date = document.getElementById('date').value || new Date().toISOString();
    if (!amount || amount <= 0) return alert('Enter a valid amount');

    const newTx = { amount, category, description, date };
    // optimistic add to cache & UI
    const added = await addExpense(newTx);
    // clear form
    e.target.reset();
    // re-render
    await renderChart();
    // show small toast/alert (simple)
    const savedMsg = document.createElement('div');
    savedMsg.className = 'toast-message small text-success';
    savedMsg.textContent = 'Expense saved';
    setTimeout(()=> savedMsg.remove(), 2000);
  });

  // events
  rangeSelect.addEventListener('change', () => renderChart());
  categorySelect.addEventListener('change', () => renderChart());

  // initial
  renderChart();

  
});
</script>

<script>
document.addEventListener('DOMContentLoaded', () => {
  APP.initThemeToggle('themeToggle');  // lever-style toggle
  APP.setActive('dashboard');
});


</script>

<script>
// If backend redirected here with ?token=..., store it and redirect clean URL
(function(){
  const params = new URLSearchParams(window.location.search);
  const token = params.get('token');
  if (token) {
    localStorage.setItem('ph_token', token);
    // Optionally fetch user profile using the token:
    // fetch('http://localhost:5000/api/protected/me', { headers: { Authorization: 'Bearer ' + token } })
    //   .then(r=>r.json()).then(d=> localStorage.setItem('ph_user', JSON.stringify(d.user || {})));

    // Remove token from URL for cleanliness
    const url = new URL(window.location.href);
    url.searchParams.delete('token');
    window.history.replaceState({}, document.title, url.pathname + url.hash);

    // reload to let app use token
    // or simply continue
  }
})();
</script>




<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
